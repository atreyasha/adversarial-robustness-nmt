#!/usr/bin/env bash
# This script mirrors the slurm-s3it branch with master,
# while keeping it ahead by a single commit for sbatch command replacements

MIRROR="slurm-s3it"
current_branch=$(git rev-parse --abbrev-ref HEAD)

if [ "$current_branch" == "master" ]; then
  printf "%s\n" "Syncing $MIRROR with master"
  local_hash=$(date +%s | sha256sum | base64 | head -c 32 ; echo)
  git stash push -u -m "$local_hash"
  git checkout "$MIRROR"
  git rebase master
  git push --force origin "$MIRROR"
  git checkout master
  stash_entry=$(git stash list | grep "$local_hash" | grep -Eo "stash@{[0-9]+}")
  if [ -n "$stash_entry" ]; then
    git stash apply "$stash_entry"
    git stash drop "$stash_entry"
  fi
fi
